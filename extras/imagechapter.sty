% Author: Nelson Lago
% This file is distributed under the MIT Licence

\ProvidesPackage{imagechapter}[2019/02/21 Images along with chapter titles]

% Permite colocar uma imagem ilustrativa junto do
% título do capítulo, através do comando
%
% \imgchapter[posição]{largura-da-imagem}{arquivo-da-imagem}{título}
%
% "posição" é opcional, o valor default é "top". Nesse caso, a imagem
% é impressa centralizada na página acima do título. "top" é adequado
% para imagens largas. Se você definir esse parâmetro como "right", a
% imagem é impressa à direita do título e, portanto, não pode ser muito
% larga.

% Esta package depende de titlesec; observe que titlesec é incompatível
% com os comandos refsection e refsegment do pacote biblatex!

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Para podermos ter a opção de imprimir ou não a imagem ilustrativa
% junto ao título dos capítulos, redefinimos o comando \chapter
% padrão para fazê-lo verificar um booleano e decidir se se deve ou
% não imprimir a imagem. Quando \chapter é chamado normalmente, esse
% booleano é falso e o comando funciona como sempre.
%
% Criamos também o comando \imgchapter, que define esse booleano como
% verdadeiro, prepara as demais variáveis necessárias e chama \chapter.
% Nesse contexto, \chapter se comporta diferentemente e imprime a imagem.

\RequirePackage[calcwidth,explicit,notocpart*,newparttoc,raggedright]{titlesec}

\newtoggle{@chapterimage} % Inicializado como "false"

% O label ("Capítulo X")
\newcommand\@chimlabel{\chaptertitlename\space\thechapter\filright}

% O nome do capítulo
\newcommand\@chimtitle[1]{#1\filright}

\titleformat{\chapter}[display]
    {\normalfont\huge\bfseries}
    {
      \iftoggle{@chapterimage}
      {\@chimlabelwithimage}
      {\@chimlabel}%
    }
    {24pt}
    {
      \iftoggle{@chapterimage}
      {\@chimtitlewithimage{#1}}
      {\@chimtitle{#1}}%
    }

\titlespacing{\chapter}{0pt}{50pt}{40pt}[40pt]

%%%%%%%%%%%%%%%%%%%%%%

\newsavebox{\@chimbox}

\newcommand\imgchapter[4][top]{
    \ifstrequal{#1}{top}
      {
        \let\@chimlabelwithimage\@chimtop
        \let\@chimtitlewithimage\@chimtitle
      }{
        \let\@chimlabelwithimage\@chimright
        \let\@chimtitlewithimage\@chimtitlewithmargin
      }

    \sbox{\@chimbox}{\includegraphics[width=#2]{#3}}

    \global\toggletrue{@chapterimage}
    \chapter{#4}
    \global\togglefalse{@chapterimage}
}

% Imprime a imagem e o label ("Capítulo X") logo abaixo
\newcommand\@chimtop{
    % Usamos \normalsize aqui porque o espaçamento neste caso é
    % definido em função de \baselineskip no tamanho normal da
    % fonte, não no tamanho do título (\huge).

    % \titlespacing, mais acima, define que o nome do capítulo é
    % impresso 50pt abaixo do topo da página. Com a imagem, não
    % queremos isso, então vamos colocar um espaçamento negativo.
    {\normalsize\dimgdef{\@backtotop}{50pt + 2\baselineskip}}
    \vspace{-\@backtotop}

    % Colocamos a imagem em um parbox para facilitar
    % o alinhamento vertical
    {\normalsize\Centering\parbox[t][][c]{\wd\@chimbox}{\usebox{\@chimbox}}\newline}

    % Após a imagem, acrescentamos o espaçamento necessário para
    % que o título seja impresso na mesma altura dos demais.
    {\normalsize\dimgdef{\@chimspace}{50pt - \ht\@chimbox - \dp\@chimbox + 1\baselineskip}}
    \vspace{\@chimspace}
    \@chimlabel
}

% Imprime o label ("Capítulo X") e a imagem à direita
\newcommand\@chimright{
      % Vamos colocar a imagem em uma box desta altura para podermos
      % centralizá-la verticalmente. O correto seria calcular a altura
      % de "Capítulo X" + o título (que pode ter uma ou mais linhas),
      % mas não faço ideia de como fazer isso, então vamos definir um
      % valor fixo e boa sorte :). 24pt é o espaço que definimos entre
      % o label e o título.
      \dimgdef{\@chimheight}{24pt + 1\baselineskip}

      % Primeiro o texto, com largura reduzida
      \dimgdef{\@chimtextwidth}{\textwidth - \wd\@chimbox - 30pt}

      \parbox[t]{\@chimtextwidth}{\@chimlabel}%
      %
      % Como estamos colocando a imagem à direita, não queremos que ela
      % influencie o espaçamento vertical; assim, usamos \smash.
      \smash{
        % Acrescenta a margem de separação entre o texto e a imagem
        \hspace{30pt}
        % Como colocamos a imagem em um parbox alinhado pelo topo, LaTeX
        % vai alinhar a borda da parbox com a baseline da linha externa.
        % Vamos usar raisebox para fazer o alinhamento no topo da linha
        % externa.
        \raisebox
          {1\baselineskip}
          {
            \parbox[t][\@chimheight][c]{\wd\@chimbox}{\usebox{\@chimbox}}
          }
      }%
}

% Ao imprimir a imagem à direita, é preciso colocar
% uma margem no nome do capítulo
\newcommand\@chimtitlewithmargin[1]{\parbox[t]{\@chimtextwidth}{\@chimtitle{#1}}}

\endinput
